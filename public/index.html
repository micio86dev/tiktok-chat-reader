<!DOCTYPE html>
<html>
  <head>
    <title>TikTok Live Quiz JS</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
        background: #111;
        color: #fff;
      }
      #messages {
        height: 200px;
        overflow-y: auto;
        margin-bottom: 20px;
        border: 1px solid #444;
        padding: 10px;
      }
      .chat {
        margin-bottom: 5px;
      }
      .gift {
        color: #ff0;
      }
      #quiz {
        margin-top: 20px;
        text-align: center;
      }
      .info {
        font-weight: bold;
        color: #0f0;
      }
      #timer {
        font-size: 3em;
        font-weight: bold;
        color: #0f0;
      }
      ul {
        list-style: none;
        padding-left: 0;
      }
      li {
        margin: 5px 0;
        font-size: 1.2em;
      }
    </style>
  </head>
  <body>
    <h1>
      Live TikTok Quiz JS -
      <span class="info">Scrivi "?" e il numero della risposta</span>
    </h1>
    <div id="messages"></div>

    <div id="quiz">
      <h2 id="question"></h2>
      <div id="timer">01:00</div>
      <ul id="options"></ul>
      <ul id="stats"></ul>
    </div>

    <script>
      const socket = io();
      const messages = document.getElementById("messages");
      const questionEl = document.getElementById("question");
      const optionsEl = document.getElementById("options");
      const statsEl = document.getElementById("stats");
      const timerEl = document.getElementById("timer");

      let countdown = null;

      // funzione per mostrare timer in formato MM:SS
      function startTimer(seconds) {
        clearInterval(countdown);
        updateTimerDisplay(seconds);
        countdown = setInterval(() => {
          seconds--;
          if (seconds < 0) {
            clearInterval(countdown);
            timerEl.textContent = "00:00";
            return;
          }
          updateTimerDisplay(seconds);
        }, 1000);
      }

      function updateTimerDisplay(seconds) {
        const m = Math.floor(seconds / 60)
          .toString()
          .padStart(2, "0");
        const s = (seconds % 60).toString().padStart(2, "0");
        timerEl.textContent = `${m}:${s}`;
      }

      // nuova domanda
      socket.on("newQuestion", (q) => {
        questionEl.textContent = q.question;
        optionsEl.innerHTML = "";
        statsEl.innerHTML = "";
        q.options.forEach((opt, i) => {
          const li = document.createElement("li");
          li.textContent = `?${i + 1} - ${opt}`;
          optionsEl.appendChild(li);
        });
        startTimer(60); // timer 60 secondi
      });

      // risultati domanda
      socket.on("questionResult", (res) => {
        statsEl.innerHTML = `
        <li>Totale risposte: ${res.total}</li>
        <li>Risposte corrette: ${res.correctCount}</li>
        <li>Percentuale corrette: ${res.percentCorrect}%</li>
      `;
      });

      // messaggi live
      socket.on("tiktokMessage", (msg) => {
        const div = document.createElement("div");
        div.className = msg.type;

        if (msg.type === "chat") {
          div.textContent = `${msg.user}: ${msg.text}`;
        } else if (msg.type === "gift") {
          div.textContent = `üéÅ ${msg.user} ha inviato un regalo!`;
        } else {
          div.textContent = JSON.stringify(msg.data);
        }

        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      });
    </script>
  </body>
</html>
