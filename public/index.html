<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MicioDev Live Games</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="style.css">

  <!-- Dependencies -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

<body>
  <div id="app">
    <!-- Header -->
    <header>
      <h1>MicioDev Live Games</h1>
    </header>

    <main>
      <!-- Quiz Area -->
      <div class="quiz-container">
        <!-- Instructions -->
        <div class="quiz-instructions" v-if="activeGameMode === 'QUIZ'">
          Scrivi il numero della risposta (es. <span class="highlight">1</span>)
        </div>

        <!-- Topic & Counter -->
        <div class="topic-header" v-if="currentTopic">
          <span class="topic-badge">{{ currentTopic }}</span>
          <span class="question-counter">{{ questionCounter }}</span>
        </div>

        <!-- Timer -->
        <div class="timer" v-if="activeGameMode === 'QUIZ'">{{ timer }}</div>

        <!-- Question -->
        <h2 class="question" v-if="currentQuestion">{{ currentQuestion }}</h2>
        <h2 class="question" v-else-if="activeGameMode === 'QUIZ'">In attesa della prossima domanda...</h2>

        <!-- Options -->
        <div class="options-grid" v-if="options.length > 0">
          <div class="option-card" v-for="(opt, index) in options" :key="index">
            <div class="option-index">{{ index + 1 }}</div>
            <div class="option-text-container">
              <span>{{ opt }}</span>
              <div class="option-count" v-if="answerCounts && answerCounts[(index + 1)]">
                {{ answerCounts[(index + 1)] }} voti
              </div>
            </div>
          </div>
        </div>

        <!-- Menu Overlay -->
        <div class="stats-overlay" v-if="showMenu">
          <div class="stats-content">
            <!-- Game Selection Step -->
            <div v-if="menuStep === 'GAME_SELECT'">
              <h3 class="stats-title">Scegli Gioco</h3>
              <div class="menu-grid" style="grid-template-columns: 1fr 1fr;">
                <button class="topic-btn" @click="selectGame('QUIZ')">
                  üß† Quiz
                </button>
                <button class="topic-btn" @click="selectGame('BATTLESHIP')">
                  üö¢ Battaglia Navale
                </button>
                <button class="topic-btn" @click="selectGame('HANGMAN')">
                  üòµ Impiccato
                </button>
              </div>
            </div>

            <!-- Quiz Topic Selection Step -->
            <div v-else-if="menuStep === 'TOPIC_SELECT'">
              <h3 class="stats-title">Scegli Argomento</h3>
              <div class="menu-grid">
                <button class="topic-btn" @click="startQuiz('js')">
                  JavaScript
                </button>
                <button class="topic-btn" @click="startQuiz('php')">
                  PHP
                </button>
                <button class="topic-btn" @click="startQuiz('python')">
                  Python
                </button>
                <button class="topic-btn" @click="startQuiz('java')">
                  Java
                </button>
                <button class="topic-btn" @click="startQuiz('html')">
                  HTML
                </button>
                <button class="topic-btn" @click="startQuiz('css')">
                  CSS
                </button>
                <button class="topic-btn" @click="startQuiz('cpp')">
                  C++
                </button>
                <button class="topic-btn" @click="startQuiz('csharp')">
                  C#
                </button>
                <button class="topic-btn" @click="startQuiz('dotnet')">
                  .NET
                </button>
                <button class="topic-btn" @click="startQuiz('c')">
                  C
                </button>
                <button class="topic-btn" @click="startQuiz('react')">
                  React
                </button>
                <button class="topic-btn" @click="startQuiz('vue')">
                  Vue
                </button>
                <button class="topic-btn" @click="startQuiz('node')">
                  Node.js
                </button>
                <button class="topic-btn" @click="startQuiz('go')">
                  Go
                </button>
                <button class="topic-btn" @click="startQuiz('rust')">
                  Rust
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Battleship Area -->
        <div class="battleship-container" v-if="activeGameMode === 'BATTLESHIP'">
          <div class="quiz-instructions">
            Spara scrivendo coordinate! (es. <span class="highlight">A5</span>, <span class="highlight">C8</span>)
          </div>

          <div class="battleship-status">
            <div class="status-item">Missili: <span class="highlight">{{ battleshipStats?.totalShots || 0 }}</span>
            </div>
            <div class="status-item">Navi Affondate: <span class="highlight">{{ battleshipStats?.sunkShips || 0
                }}/5</span></div>
          </div>

          <div class="battleship-grid">
            <!-- Header Row (A-J) -->
            <div class="grid-row header">
              <div class="grid-cell label"></div>
              <div class="grid-cell label" v-for="col in ['A','B','C','D','E','F','G','H','I','J']">{{col}}</div>
            </div>
            <!-- Rows 1-10 -->
            <div class="grid-row" v-for="(row, rIndex) in battleshipGrid" :key="rIndex">
              <div class="grid-cell label">{{ rIndex + 1 }}</div>
              <div class="grid-cell" v-for="(cell, cIndex) in row" :key="cIndex" :class="{
                              'cell-water': cell === 0,
                              'cell-ship': cell === 1,
                              'cell-hit': cell === 2,
                              'cell-miss': cell === 3
                          }">
                <!-- Optional: Animation/Icon -->
                <span v-if="cell === 2">üí•</span>
                <span v-if="cell === 3">üåä</span>
              </div>
            </div>
          </div>

          <div class="last-action" v-if="battleshipStats?.lastResult">
            {{ battleshipStats.lastShooter }}: {{ battleshipStats.lastResult }}
          </div>
        </div>

        <!-- Hangman Area -->
        <div class="hangman-container" v-if="activeGameMode === 'HANGMAN' && hangmanState">
          <div class="quiz-instructions">
            Indovina la parola scrivendo una lettera!
          </div>

          <div class="hangman-visual">
            <!-- Simple CSS or SVG Hangman could go here, for now just text/counter -->
            <div class="error-counter">
              Errori: <span class="highlight"
                :class="{'text-error': hangmanState.wrongAttempts >= hangmanState.maxAttempts - 1}">
                {{ hangmanState.wrongAttempts }} / {{ hangmanState.maxAttempts }}
              </span>
            </div>
          </div>

          <div class="word-display">
            <span v-for="(char, index) in hangmanState.maskedWord" :key="index" class="word-char">
              {{ char }}
            </span>
          </div>

          <div class="guessed-letters">
            Lettere usate:
            <span v-for="letter in hangmanState.guessed" :key="letter" class="guessed-char">
              {{ letter }}
            </span>
          </div>

          <div class="hangman-status" v-if="hangmanState.status !== 'PLAYING'">
            <h2 v-if="hangmanState.status === 'WON'" class="text-success">VITTORIA! üéâ</h2>
            <h2 v-if="hangmanState.status === 'LOST'" class="text-error">GAME OVER ‚ò†Ô∏è</h2>
            <div v-if="hangmanState.status === 'LOST'">La parola era: {{ hangmanState.word }}</div>
          </div>

          <div class="last-action" v-if="hangmanState.lastGuesser">
            Ultimo tentativo: {{ hangmanState.lastGuesser }}
          </div>
        </div>

        <!-- Topic Selection Overlay -->
        <div class="topic-selection-overlay" v-if="topicSelection.active">
          <div class="topic-selection-content">
            <h3>Estraendo prossimo argomento...</h3>
            <div class="topic-spinner">
              {{ topicSelection.current }}
            </div>
          </div>
        </div>

        <!-- Stats Overlay -->
        <div class="stats-overlay" v-if="stats">
          <div class="stats-content">
            <h3 class="stats-title">Risultati</h3>
            <div class="stat-item">
              <span>Totale Risposte:</span>
              <span class="highlight">{{ stats.total }}</span>
            </div>
            <div class="stat-item">
              <span>Corrette:</span>
              <span class="highlight">{{ stats.correctCount }}</span>
            </div>
            <div class="stat-item">
              <span>Precisione:</span>
              <span class="highlight">{{ stats.percentCorrect }}%</span>
            </div>

            <!-- Leaderboard -->
            <div class="leaderboard" v-if="stats.winners && stats.winners.length > 0">
              <h4>üèÜ Top Risposte Corrette</h4>
              <div class="winners-list">
                <div class="winner-item" v-for="(winner, index) in stats.winners" :key="index">
                  <span class="winner-rank">#{{ index + 1 }}</span>
                  <img :src="winner.avatar || 'https://via.placeholder.com/32'" class="winner-avatar" alt="Avatar">
                  <span class="winner-name">{{ winner.nickname }}</span>
                </div>
              </div>
            </div>
            <!-- Question Stats Breakdown -->
            <div class="question-stats-container" v-if="stats.questionStats && stats.questionStats.length > 0">
              <h4>üìä Dettaglio Domande</h4>
              <div class="questions-list">
                <div class="question-stat-item" v-for="(qStat, index) in stats.questionStats" :key="index">
                  <div class="qs-header">
                    <span class="qs-id">#{{ index + 1 }}</span>
                    <span class="qs-text">{{ qStat.text }}</span>
                  </div>
                  <div class="qs-details">
                    <div class="qs-answer">
                      ‚úÖ {{ qStat.correctAnswer }}
                    </div>
                    <div class="qs-metrics">
                      <span class="qs-metric highlight">{{ qStat.percentCorrect }}%</span>
                      <span class="qs-metric-label">({{ qStat.correctCount }}/{{ qStat.totalAnswers }})</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="no-winners" v-else-if="stats.winners">
              Nessuna risposta corretta üò¢
            </div>

            <!-- Restart Button and Auto-restart Timer -->
            <div class="restart-container">
              <button class="restart-btn" @click="resetQuiz">
                üîÑ Nuovo Quiz <span v-if="restartCountdown">({{ restartCountdown }}s)</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Feed -->
      <div class="chat-container">
        <div class="chat-header">
          <div class="live-indicator"></div>
          Live Chat
        </div>
        <div class="chat-messages" ref="chatContainer">
          <div v-for="(msg, index) in messages" :key="index" class="chat-message"
            :class="{ 'gift-message': msg.type === 'gift' }">
            <img :src="msg.avatar || 'https://via.placeholder.com/32'" class="avatar" alt="Avatar">
            <div class="chat-content" :class="{ 'gift-content': msg.type === 'gift' }">
              <div class="nickname">{{ msg.nickname }}</div>
              <div v-if="msg.type === 'chat'">{{ msg.text }}</div>
              <div v-else-if="msg.type === 'gift'">üéÅ Ha inviato {{ msg.gift }}!</div>
              <div v-else>{{ JSON.stringify(msg.data) }}</div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- App Logic -->
  <script src="app.js"></script>
</body>

</html>